(()=>{"use strict";var t={n:a=>{var e=a&&a.__esModule?()=>a.default:()=>a;return t.d(e,{a:e}),e},d:(a,e)=>{for(var n in e)t.o(e,n)&&!t.o(a,n)&&Object.defineProperty(a,n,{enumerable:!0,get:e[n]})},o:(t,a)=>Object.prototype.hasOwnProperty.call(t,a)};const a=window.jQuery;var e=t.n(a);e()(function(){const t=e()("#image-area-svg"),a=t.find(".area-lines"),n=t.find(".area-texts"),o=e()("#image-position-list tbody"),i=wp.template("area-settings"),s=e()("#image-action-list tbody"),r=wp.template("action-settings");if(void 0!==t){let l=!1,d=!1,c=null,h=null;e().ajax({url:ajaxurl+"?action=ry-line/get-image-areas",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.get}}).done(function(t){if(t.success&&Array.isArray(t.data.areas)&&t.data.areas.length)return p(360),void u(t.data.areas);p(720),f()});const p=a=>{a=Math.min(a,.6*t.closest(".postbox").width()),t.parent().width(a),t.data("ratio",a/parseInt(t.data("width")));const n=parseInt(t.data("width"))*t.data("ratio"),o=parseInt(t.data("height"))*t.data("ratio");t.attr({width:n,height:o,viewBox:`0 0 ${n} ${o}`}),e()("#bg-pattern").attr({width:n,height:o}),e()("#bg-pattern image").attr({width:n,height:o,href:t.data("bg")})};e()(document).on("mouseup",function(a){if(!l&&!d)return;if(d){h.removeClass("dragging");let t=g(a);return h.hasClass("horizontal")?h.attr({y1:t.y,y2:t.y,stroke:"#0000ff"}):h.attr({x1:t.x,x2:t.x,stroke:"#0000ff"}),m(),y(),d=!1,void(c=null)}t.removeClass(["drawing"]);let n=v(a);Math.abs(n.x-c.x)>Math.abs(n.y-c.y)?(n.y=c.y,h.addClass(["horizontal"])):(n.x=c.x,h.addClass(["vertical"])),Math.abs(c.x-n.x)+Math.abs(c.y-n.y)>20&&b(n.x,n.y)?(h.removeClass(["temp-line"]).addClass(["permanent-line"]).attr({x1:c.x,y1:c.y,x2:n.x,y2:n.y,stroke:"#0000ff","stroke-dasharray":""}),h.on("dblclick",function(){e()(this).remove(),m()}),y()):h.remove(),l=!1,c=null,h=null});const f=()=>{s.off("change"),t.find("rect.bg").attr("opacity",0),o.closest("table").show(),s.closest("table").hide(),e()(".ry-create-menu").hide(),t.on("mousedown",function(n){n.preventDefault();const o=v(n);if(n.target.classList.contains("permanent-line"))return d=!0,c=o,h=e()(n.target),void h.addClass(["dragging"]);b(o.x,o.y)&&(t.addClass(["drawing"]),l=!0,c=o,h=e()(document.createElementNS("http://www.w3.org/2000/svg","line")),h.addClass(["temp-line"]).attr({x1:c.x,y1:c.y,x2:c.x,y2:c.y,stroke:"#ff0000","stroke-width":2,"stroke-dasharray":"5,5"}),a.append(h))}),t.on("mousemove",function(t){if(!l&&!d)return;if(d){let a=g(t);return h.hasClass("horizontal")?h.attr({y1:a.y,y2:a.y,stroke:"#00ff00"}):h.attr({x1:a.x,x2:a.x,stroke:"#00ff00"}),void y()}let a=v(t);Math.abs(a.x-c.x)>Math.abs(a.y-c.y)?a.y=c.y:a.x=c.x,h.attr({x2:a.x,y2:a.y,stroke:b(a.x,a.y)?"#00ff00":"#ff0000"})}),y()},u=i=>{t.off("mousedown"),t.off("mousemove"),t.find("rect.bg").attr("opacity",.04),o.closest("table").hide(),s.closest("table").show(),e()(".ry-create-menu").hide(),s.empty(),n.empty(),s.on("change",".action-type",function(){e()(this).closest("tr").find(".action-info").hide(),e()(this).closest("tr").find(".action-info-"+e()(this).val()).show()});let l=!1;for(const n in i){const o=i[n];x((o.bounds.x+o.bounds.width/2)*t.data("ratio"),(o.bounds.y+o.bounds.height/2)*t.data("ratio"),n);const d=e()(document.createElementNS("http://www.w3.org/2000/svg","rect"));d.attr({x:o.bounds.x*t.data("ratio"),y:o.bounds.y*t.data("ratio"),width:o.bounds.width*t.data("ratio"),height:o.bounds.height*t.data("ratio"),fill:"none",stroke:"#0000ff","stroke-width":1}),a.append(d),s.append(r({idx:n,areaStart:`( ${o.bounds.x}, ${o.bounds.y} )`,areaSize:`${o.bounds.width} x ${o.bounds.height}`}));const c=s.find("tr").last();switch(c.find(".action-type").val(o.action.type).trigger("change"),o.action.type){case"uri":c.find(`#action-info-${n}-uri`).val(o.action.uri),c.find(`#action-info-${n}-label`).val(o.action.label),l=!0;break;case"message":c.find(`#action-info-${n}-text`).val(o.action.text),c.find(`#action-info-${n}-label`).val(o.action.label),l=!0;break;case"selfmessage":c.find(`#action-info-${n}-message`).val(o.action.message),c.find(`#action-info-${n}-label`).val(o.action.label),l=!0;break;case"richmenuswitch":c.find(`#action-info-${n}-richMenuAliasId`).val(o.action.richMenuAliasId),l=!0;break;case"accountlink":c.find(`#action-info-${n}-text`).val(o.action.displayText),c.find(`#action-info-${n}-label`).val(o.action.label),l=!0}}l&&e()(".ry-create-menu").show()},y=()=>{const s=parseFloat(t.attr("width")),r=parseFloat(t.attr("height")),l=[];a.find("line.permanent-line").each(function(){l.push({x1:parseFloat(e()(this).attr("x1")),y1:parseFloat(e()(this).attr("y1")),x2:parseFloat(e()(this).attr("x2")),y2:parseFloat(e()(this).attr("y2"))})});const d=new Set([0,s]),c=new Set([0,r]);l.forEach(t=>{d.add(t.x1),d.add(t.x2),c.add(t.y1),c.add(t.y2)});const h=Array.from(d).sort((t,a)=>t-a),p=Array.from(c).sort((t,a)=>t-a),f={};for(let t=0;t<p.length-1;t++)for(let a=t+1;a<p.length;a++)for(let e=0;e<h.length-1;e++)for(let n=e+1;n<h.length;n++){let o=h[e],i=h[n],s=p[t],r=p[a];void 0===f[`${o}, ${s}`]&&M(o,s,i,r,l)&&(f[`${o}, ${s}`]={left:o,top:s,right:i,bottom:r})}o.empty(),n.empty(),Object.values(f).forEach((a,e)=>{x((a.left+a.right)/2,(a.top+a.bottom)/2,e);const n=Math.floor(a.left/t.data("ratio")),s=Math.floor(a.top/t.data("ratio")),r=Math.floor(a.right/t.data("ratio")),l=Math.floor(a.bottom/t.data("ratio")),d=parseFloat(t.attr("width"))/t.data("ratio")/360;let c=Math.round((r-n)/d),h=Math.round((l-s)/d);c<30&&(c=`<strong class="file-error">${c}</strong>`),h<30&&(h=`<strong class="file-error">${h}</strong>`),o.append(i({idx:e,value:`${n?n+1:0}-${s?s+1:0}-${r-n}-${l-s}`,phoneSize:`${c} x ${h}`,areaStart:`( ${n?n+1:0} , ${s?s+1:0} )`,areaSize:`${r-n} x ${l-s}`}))})},m=()=>{let t=[];if(a.find("line.permanent-line").each(function(){let a=e()(this);a.addClass(["pre-delete"]).removeClass(["permanent-line"]),b(a.attr("x1"),a.attr("y1"))&&b(a.attr("x2"),a.attr("y2"))?a.addClass(["permanent-line"]).removeClass(["pre-delete"]):t.push(a)}),t.length){for(;t.length;)t.pop().remove();m()}else y()},x=(t,a,o)=>{const i=e()(document.createElementNS("http://www.w3.org/2000/svg","circle"));i.attr({cx:t,cy:a,fill:"#000",opacity:"0.075"}),n.append(i);const s=e()(document.createElementNS("http://www.w3.org/2000/svg","text"));s.attr({x:t,y:a,dy:"2px","text-anchor":"middle","dominant-baseline":"middle"}),s.text(o),n.append(s),i.attr({r:Math.floor(Math.max(s[0].getBBox().width,s[0].getBBox().height)/2)})},g=a=>{const e=t[0].getBoundingClientRect(),n=parseFloat(t.attr("width")),o=parseFloat(t.attr("height"));return{x:(a.clientX-e.left)/e.width*n,y:(a.clientY-e.top)/e.height*o}},v=n=>{const o=parseFloat(t.attr("width")),i=parseFloat(t.attr("height"));let{x:s,y:r}=g(n);return s<=20&&(s=0),s>=o-20&&(s=o),r<=20&&(r=0),r>=i-20&&(r=i),a.find("line.permanent-line").each(function(){const t={x1:parseFloat(e()(this).attr("x1")),y1:parseFloat(e()(this).attr("y1")),x2:parseFloat(e()(this).attr("x2")),y2:parseFloat(e()(this).attr("y2"))};w(s,r,t,20)&&(Math.abs(t.y1-t.y2)<1?r=t.y1:Math.abs(t.x1-t.x2)<1&&(s=t.x1))}),{x:s,y:r}},b=(n,o)=>{const i=parseFloat(t.attr("width")),s=parseFloat(t.attr("height")),r=.1;if(n=parseFloat(n),o=parseFloat(o),n<=r||n>=i-r||o<=r||o>=s-r)return!0;let l=!1;return a.find("line.permanent-line").each(function(){const t={x1:parseFloat(e()(this).attr("x1")),y1:parseFloat(e()(this).attr("y1")),x2:parseFloat(e()(this).attr("x2")),y2:parseFloat(e()(this).attr("y2"))};w(n,o,t,r)&&(l=!0)}),l},w=(t,a,e,n)=>{const{x1:o,y1:i,x2:s,y2:r}=e;return Math.abs(i-r)<n?Math.abs(a-i)<=n&&t>=Math.min(o,s)-n&&t<=Math.max(o,s)+n:Math.abs(o-s)<n&&Math.abs(t-o)<=n&&a>=Math.min(i,r)-n&&a<=Math.max(i,r)+n},M=(t,a,e,n,o)=>{const i=.1,s=j(t,a,e,a,o,i),r=j(e,a,e,n,o,i),l=j(t,n,e,n,o,i),d=j(t,a,t,n,o,i);return s&&r&&l&&d},j=(a,e,n,o,i,s)=>{const r=parseFloat(t.attr("width")),l=parseFloat(t.attr("height"));if(Math.abs(e)<=s&&Math.abs(o)<=s||Math.abs(a)<=s&&Math.abs(n)<=s||Math.abs(e-l)<=s&&Math.abs(o-l)<=s||Math.abs(a-r)<=s&&Math.abs(n-r)<=s)return!0;for(const t of i)if(_(a,e,n,o,t,s))return!0;return!1},_=(t,a,e,n,o,i)=>{const{x1:s,y1:r,x2:l,y2:d}=o;if(Math.abs(a-n)<i&&Math.abs(r-d)<i){if(Math.abs(a-r)<=i){const a=Math.min(t,e),n=Math.max(t,e),o=Math.min(s,l),r=Math.max(s,l);return o<=a+i&&r>=n-i}}else if(Math.abs(t-e)<i&&Math.abs(s-l)<i&&Math.abs(t-s)<=i){const t=Math.min(a,n),e=Math.max(a,n),o=Math.min(r,d),s=Math.max(r,d);return o<=t+i&&s>=e-i}return!1};e()(".ry-reset-areas").on("click",function(){a.empty(),f()}),e()(".ry-save-position").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/save-image-position",method:"POST",dataType:"json",data:{areas:decodeURIComponent(o.closest("fieldset").serialize()),post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.position}}).done(function(t){t.success&&Array.isArray(t.data)&&t.data.length?u(t.data):f()}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-save-action").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/save-image-actions",method:"POST",dataType:"json",data:{actions:decodeURIComponent(s.closest("fieldset").serialize()),post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.actions}}).done(function(t){t.success&&Array.isArray(t.data)&&t.data.length?u(t.data):f()}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})})}e()("textarea").on("input",function(){let t=e()(this);t.height("auto"),t.height(Math.min(400,t[0].scrollHeight+30))}).trigger("input"),e()("#message-type").on("change",function(){e()("#postimagediv").hide(),e()(".type-info").hide(),e()(".type-info-"+e()(this).val()).show(),"image"==e()(this).val()&&e()("#postimagediv").show()}).trigger("change"),e()("#reply-keyword").on("input",function(){e()(".reply-info").hide(),""!=e()(this).val()&&e()(".reply-info").show()}).trigger("input"),e()(".ry-send-test").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-message-testsend",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.testsend}}).done(function(t){t.success||l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-create-menu").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-create",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.create}}).done(function(t){t.success?location.reload():l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-set-alias").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-alias",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),alias:e()("#menu-alias").val(),_ajax_nonce:RYLineMetabox.nonce.alias}}).done(function(t){t.success?e()("#menu-alias").val(t.data):l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-set-test").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-test",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.test}}).done(function(t){t.success||l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-default-menu").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-default",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.default}}).done(function(t){t.success?a.text(t.data):l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-delete-menu").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-delete",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.delete}}).done(function(t){t.success?location.reload():l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})});const l=function(t){let a=t.message;if(void 0!==t.details)for(const e of t.details)a+=`\n- ${e.message} ( ${e.property} )`;alert(a)}})})();