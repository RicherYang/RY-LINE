(()=>{"use strict";var t={n:a=>{var e=a&&a.__esModule?()=>a.default:()=>a;return t.d(e,{a:e}),e},d:(a,e)=>{for(var n in e)t.o(e,n)&&!t.o(a,n)&&Object.defineProperty(a,n,{enumerable:!0,get:e[n]})},o:(t,a)=>Object.prototype.hasOwnProperty.call(t,a)};const a=window.jQuery;var e=t.n(a);e()(function(){const t=e()("#image-area-svg"),a=t.find(".area-lines"),n=t.find(".area-texts"),i=e()("#image-position-list tbody"),o=wp.template("area-settings"),s=e()("#image-action-list tbody"),r=wp.template("action-settings");if(void 0!==t){let l=!1,c=!1,d=null,p=null;e().ajax({url:ajaxurl+"?action=ry-line/get-image-areas",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.get}}).done(function(t){if(t.success&&Array.isArray(t.data.areas)&&t.data.areas.length)return h(360),void u(t.data.areas);h(720),f()});const h=a=>{a=Math.min(a,.6*t.closest(".postbox").width()),t.parent().width(a),t.data("ratio",a/parseInt(t.data("width")));const n=parseInt(t.data("width"))*t.data("ratio"),i=parseInt(t.data("height"))*t.data("ratio");t.attr({width:n,height:i,viewBox:`0 0 ${n} ${i}`}),e()("#bg-pattern").attr({width:n,height:i}),e()("#bg-pattern image").attr({width:n,height:i,href:t.data("bg")})};e()(document).on("mouseup",function(a){if(!l&&!c)return;if(c){p.removeClass("dragging");let t=x(a);return p.hasClass("horizontal")?p.attr({y1:t.y,y2:t.y,stroke:"#0000ff"}):p.attr({x1:t.x,x2:t.x,stroke:"#0000ff"}),y(),m(),c=!1,void(d=null)}t.removeClass(["drawing"]);let n=v(a);Math.abs(n.x-d.x)>Math.abs(n.y-d.y)?(n.y=d.y,p.addClass(["horizontal"])):(n.x=d.x,p.addClass(["vertical"])),Math.abs(d.x-n.x)+Math.abs(d.y-n.y)>20&&b(n.x,n.y)?(p.removeClass(["temp-line"]).addClass(["permanent-line"]).attr({x1:d.x,y1:d.y,x2:n.x,y2:n.y,stroke:"#0000ff","stroke-dasharray":""}),p.on("dblclick",function(){e()(this).remove(),y()}),m()):p.remove(),l=!1,d=null,p=null});const f=()=>{s.off("change"),t.find("rect.bg").attr("opacity",0),i.closest("table").show(),s.closest("table").hide(),e()(".ry-create-menu").hide(),t.on("mousedown",function(n){n.preventDefault();const i=v(n);if(n.target.classList.contains("permanent-line"))return c=!0,d=i,p=e()(n.target),void p.addClass(["dragging"]);b(i.x,i.y)&&(t.addClass(["drawing"]),l=!0,d=i,p=e()(document.createElementNS("http://www.w3.org/2000/svg","line")),p.addClass(["temp-line"]).attr({x1:d.x,y1:d.y,x2:d.x,y2:d.y,stroke:"#ff0000","stroke-width":2,"stroke-dasharray":"5,5"}),a.append(p))}),t.on("mousemove",function(t){if(!l&&!c)return;if(c){let a=x(t);return p.hasClass("horizontal")?p.attr({y1:a.y,y2:a.y,stroke:"#00ff00"}):p.attr({x1:a.x,x2:a.x,stroke:"#00ff00"}),void m()}let a=v(t);Math.abs(a.x-d.x)>Math.abs(a.y-d.y)?a.y=d.y:a.x=d.x,p.attr({x2:a.x,y2:a.y,stroke:b(a.x,a.y)?"#00ff00":"#ff0000"})}),m()},u=o=>{t.off("mousedown"),t.off("mousemove"),t.find("rect.bg").attr("opacity",.04),i.closest("table").hide(),s.closest("table").show(),e()(".ry-create-menu").hide(),s.empty(),n.empty(),s.on("change",".action-type",function(){e()(this).closest("tr").find(".action-info").hide(),e()(this).closest("tr").find(".action-info-"+e()(this).val()).show()});let l=!1;for(const n in o){const i=o[n];g((i.bounds.x+i.bounds.width/2)*t.data("ratio"),(i.bounds.y+i.bounds.height/2)*t.data("ratio"),n);const c=e()(document.createElementNS("http://www.w3.org/2000/svg","rect"));c.attr({x:i.bounds.x*t.data("ratio"),y:i.bounds.y*t.data("ratio"),width:i.bounds.width*t.data("ratio"),height:i.bounds.height*t.data("ratio"),fill:"none",stroke:"#0000ff","stroke-width":1}),a.append(c),s.append(r({idx:n,areaStart:`( ${i.bounds.x}, ${i.bounds.y} )`,areaSize:`${i.bounds.width} x ${i.bounds.height}`}));const d=s.find("tr").last();switch(d.find(".action-type").val(i.action.type).trigger("change"),i.action.type){case"uri":d.find(`#action-info-${n}-uri`).val(i.action.uri),d.find(`#action-info-${n}-label`).val(i.action.label),l=!0;break;case"message":d.find(`#action-info-${n}-text`).val(i.action.text),d.find(`#action-info-${n}-label`).val(i.action.label),l=!0;break;case"selfmessage":d.find(`#action-info-${n}-message`).val(i.action.message),d.find(`#action-info-${n}-label`).val(i.action.label),l=!0;break;case"richmenuswitch":d.find(`#action-info-${n}-richMenuAliasId`).val(i.action.richMenuAliasId),l=!0;break;case"accountlink":d.find(`#action-info-${n}-text`).val(i.action.displayText),d.find(`#action-info-${n}-label`).val(i.action.label),l=!0}}l&&e()(".ry-create-menu").show()},m=()=>{const s=parseFloat(t.attr("width")),r=parseFloat(t.attr("height")),l=[];a.find("line.permanent-line").each(function(){l.push({x1:parseFloat(e()(this).attr("x1")),y1:parseFloat(e()(this).attr("y1")),x2:parseFloat(e()(this).attr("x2")),y2:parseFloat(e()(this).attr("y2"))})});const c=new Set([0,s]),d=new Set([0,r]);l.forEach(t=>{c.add(t.x1),c.add(t.x2),d.add(t.y1),d.add(t.y2)});const p=Array.from(c).sort((t,a)=>t-a),h=Array.from(d).sort((t,a)=>t-a),f={};for(let t=0;t<h.length-1;t++)for(let a=t+1;a<h.length;a++)for(let e=0;e<p.length-1;e++)for(let n=e+1;n<p.length;n++){let i=p[e],o=p[n],s=h[t],r=h[a];void 0===f[`${i}, ${s}`]&&M(i,s,o,r,l)&&(f[`${i}, ${s}`]={left:i,top:s,right:o,bottom:r})}i.empty(),n.empty(),Object.values(f).forEach((a,e)=>{g((a.left+a.right)/2,(a.top+a.bottom)/2,e);const n=Math.floor(a.left/t.data("ratio")),s=Math.floor(a.top/t.data("ratio")),r=Math.floor(a.right/t.data("ratio")),l=Math.floor(a.bottom/t.data("ratio")),c=parseFloat(t.attr("width"))/t.data("ratio")/360;let d=Math.round((r-n)/c),p=Math.round((l-s)/c);d<30&&(d=`<strong class="file-error">${d}</strong>`),p<30&&(p=`<strong class="file-error">${p}</strong>`),i.append(o({idx:e,value:`${n?n+1:0}-${s?s+1:0}-${r-n}-${l-s}`,phoneSize:`${d} x ${p}`,areaStart:`( ${n?n+1:0} , ${s?s+1:0} )`,areaSize:`${r-n} x ${l-s}`}))})},y=()=>{let t=[];if(a.find("line.permanent-line").each(function(){let a=e()(this);a.addClass(["pre-delete"]).removeClass(["permanent-line"]),b(a.attr("x1"),a.attr("y1"))&&b(a.attr("x2"),a.attr("y2"))?a.addClass(["permanent-line"]).removeClass(["pre-delete"]):t.push(a)}),t.length){for(;t.length;)t.pop().remove();y()}else m()},g=(t,a,i)=>{const o=e()(document.createElementNS("http://www.w3.org/2000/svg","circle"));o.attr({cx:t,cy:a,fill:"#000",opacity:"0.075"}),n.append(o);const s=e()(document.createElementNS("http://www.w3.org/2000/svg","text"));s.attr({x:t,y:a,dy:"2px","text-anchor":"middle","dominant-baseline":"middle"}),s.text(i),n.append(s),o.attr({r:Math.floor(Math.max(s[0].getBBox().width,s[0].getBBox().height)/2)})},x=a=>{const e=t[0].getBoundingClientRect(),n=parseFloat(t.attr("width")),i=parseFloat(t.attr("height"));return{x:(a.clientX-e.left)/e.width*n,y:(a.clientY-e.top)/e.height*i}},v=n=>{const i=parseFloat(t.attr("width")),o=parseFloat(t.attr("height"));let{x:s,y:r}=x(n);return s<=20&&(s=0),s>=i-20&&(s=i),r<=20&&(r=0),r>=o-20&&(r=o),a.find("line.permanent-line").each(function(){const t={x1:parseFloat(e()(this).attr("x1")),y1:parseFloat(e()(this).attr("y1")),x2:parseFloat(e()(this).attr("x2")),y2:parseFloat(e()(this).attr("y2"))};w(s,r,t,20)&&(Math.abs(t.y1-t.y2)<1?r=t.y1:Math.abs(t.x1-t.x2)<1&&(s=t.x1))}),{x:s,y:r}},b=(n,i)=>{const o=parseFloat(t.attr("width")),s=parseFloat(t.attr("height")),r=.1;if(n=parseFloat(n),i=parseFloat(i),n<=r||n>=o-r||i<=r||i>=s-r)return!0;let l=!1;return a.find("line.permanent-line").each(function(){const t={x1:parseFloat(e()(this).attr("x1")),y1:parseFloat(e()(this).attr("y1")),x2:parseFloat(e()(this).attr("x2")),y2:parseFloat(e()(this).attr("y2"))};w(n,i,t,r)&&(l=!0)}),l},w=(t,a,e,n)=>{const{x1:i,y1:o,x2:s,y2:r}=e;return Math.abs(o-r)<n?Math.abs(a-o)<=n&&t>=Math.min(i,s)-n&&t<=Math.max(i,s)+n:Math.abs(i-s)<n&&Math.abs(t-i)<=n&&a>=Math.min(o,r)-n&&a<=Math.max(o,r)+n},M=(t,a,e,n,i)=>{const o=.1,s=j(t,a,e,a,i,o),r=j(e,a,e,n,i,o),l=j(t,n,e,n,i,o),c=j(t,a,t,n,i,o);return s&&r&&l&&c},j=(a,e,n,i,o,s)=>{const r=parseFloat(t.attr("width")),l=parseFloat(t.attr("height"));if(Math.abs(e)<=s&&Math.abs(i)<=s||Math.abs(a)<=s&&Math.abs(n)<=s||Math.abs(e-l)<=s&&Math.abs(i-l)<=s||Math.abs(a-r)<=s&&Math.abs(n-r)<=s)return!0;for(const t of o)if(_(a,e,n,i,t,s))return!0;return!1},_=(t,a,e,n,i,o)=>{const{x1:s,y1:r,x2:l,y2:c}=i;if(Math.abs(a-n)<o&&Math.abs(r-c)<o){if(Math.abs(a-r)<=o){const a=Math.min(t,e),n=Math.max(t,e),i=Math.min(s,l),r=Math.max(s,l);return i<=a+o&&r>=n-o}}else if(Math.abs(t-e)<o&&Math.abs(s-l)<o&&Math.abs(t-s)<=o){const t=Math.min(a,n),e=Math.max(a,n),i=Math.min(r,c),s=Math.max(r,c);return i<=t+o&&s>=e-o}return!1};e()(".ry-reset-areas").on("click",function(){a.empty(),f()}),e()(".ry-save-position").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/save-image-position",method:"POST",dataType:"json",data:{areas:decodeURIComponent(i.closest("fieldset").serialize()),post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.position}}).done(function(t){t.success&&Array.isArray(t.data)&&t.data.length?u(t.data):f()}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-save-action").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/save-image-actions",method:"POST",dataType:"json",data:{actions:decodeURIComponent(s.closest("fieldset").serialize()),post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.actions}}).done(function(t){t.success&&Array.isArray(t.data)&&t.data.length?u(t.data):f()}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})})}e()("textarea").on("input",function(){let t=e()(this);t.height("auto"),t.height(Math.min(400,t[0].scrollHeight+30))}).trigger("input"),e()("#message-type").on("input",function(){e()("#postimagediv").hide(),e()(".type-info").hide(),e()(".type-info-"+e()(this).val()).show(),"image"==e()(this).val()&&e()("#postimagediv").show()}).trigger("input"),e()('[name="reply-type"]').on("input",function(){e()(".reply-info").hide(),e()(".reply-info-"+e()(this).val()).show()}),e()('[name="reply-type"]:checked').trigger("input"),e()('[name="autosend-event[]"]').on("input",function(){e()(".event-info").hide(),e()('[name="autosend-event[]"]:checked').length&&e()(".event-info").show()}).first().trigger("input"),e()(".ry-send-test").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-message-testsend",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.testsend}}).done(function(t){t.success||l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-create-menu").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-create",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.create}}).done(function(t){t.success?location.reload():l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-set-alias").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-alias",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),alias:e()("#menu-alias").val(),_ajax_nonce:RYLineMetabox.nonce.alias}}).done(function(t){t.success?e()("#menu-alias").val(t.data):l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-set-test").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-test",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.test}}).done(function(t){t.success||l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-default-menu").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-default",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.default}}).done(function(t){t.success?a.text(t.data):l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})}),e()(".ry-delete-menu").on("click",function(t){if(t.isPropagationStopped())return;let a=e()(this);e().ajax({url:ajaxurl+"?action=ry-line/remote-richmenu-delete",method:"POST",dataType:"json",data:{post_id:e()("#post_ID").val(),_ajax_nonce:RYLineMetabox.nonce.delete}}).done(function(t){t.success?location.reload():l(t.data)}).always(function(){a.parent().find("span.spinner").removeClass("is-active").remove()})});const l=function(t){let a=t.message;if(void 0!==t.details)for(const e of t.details)a+=`\n- ${e.message} ( ${e.property} )`;alert(a)};let c,d=e()(".ry-template-string");if(d.length){const t=e()("#ry-template-dialog"),a=()=>{t.animate({opacity:0},400,function(){t.css("visibility","hidden")})};t.on("click",".template-group-item",function(){const a=e()(this);t.find(".template-group-item").removeClass(["active"]),a.addClass(["active"]);const n=wp.template("string-item"),i=t.find(".template-string");i.empty(),a.data("strings").forEach(t=>{i.append(n(t))})}),t.on("click",".template-string-item",function(){const t=c[0],n=c.val(),i=t.selectionStart||n.length,o=" "+e()(this).find("code").text()+" ";c.val(n.slice(0,i)+o+n.slice(i));const s=i+o.length;t.setSelectionRange(s,s),c.trigger("focus"),a()}),setTimeout(()=>{const a=wp.template("group-item"),e=t.find(".template-group");for(const t of RYLineMetabox.templateString)e.append(a({name:t.name})),e.find(".template-group-item:last").data("strings",t.strings);e.find(".template-group-item:first").trigger("click")}),d.on("click",function(a){const n=e()(this),i=n.position(),o=n.outerHeight();c=e()(n.data("target")),0!=c.length&&(t.css({left:i.left+n.outerWidth()+20+"px",top:i.top+"px",visibility:"visible"}),t.position().left+t.outerWidth()>e()(window).width()-20&&t.css({left:i.left-t.outerWidth()-20+"px"}),t.position().top+t.outerHeight()>e()(window).height()-20&&t.css({top:Math.max(20,i.top-t.outerHeight()+o)+"px"}),t.animate({opacity:1},400))}),e()(document).on("click",function(n){1!=t.css("opacity")||e()(n.target).closest("#ry-template-dialog, .ry-template-string").length||a()})}})})();